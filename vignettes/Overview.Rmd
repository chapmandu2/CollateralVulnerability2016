---
title: "Collateral Vulnerability Overview Vignette"
author: "Phil Chapman"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Vignette Title}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, echo=FALSE, message=FALSE}
library(CollateralVulnerability2016)
library(dplyr)
```

## Introduction

## Step 1: Set up SQLite database and directories
```{r eval=TRUE}
work_dir <- '~/BigData/CollateralVulnerability2016/skcm/'
download_dir <- '~/BigData/RTCGA_downloads/'
mydb <- 'skcm_output.db'
mydb_path <- paste0(work_dir, mydb)
my_con <- setupSQLite ( mydb_path ) 

```

## Step 2: Get human geneset to work with
In this case we want all human genes using the most recent ENSEMBL annotation:
```{r eval=TRUE}
all_genes <- getAllHumanGenes(my_con)
head(all_genes)

```
Gene data also written to SQLite database and can be viewed with dplyr:
```{r eval=TRUE}
src_sqlite(my_con@dbname) %>% tbl('human_genes')
```
## Step 3: Import TCGA RNAseq and mutation data
Want to import the TCGA RNAseq and mutation data so that it is ready to use for further analyses
```{r eval=FALSE}

rnaseq_dat <- getTCGARNAseqData(my_con, cancerTypes='SKCM', releaseDate = '2015-11-01', sampletag=c('01A', '06A'))
dim(rnaseq_dat)

mutation_dat <- getTCGAMutationData(my_con, cancerTypes='SKCM', releaseDate = '2015-11-01', sampletag=c('01A', '06A'))
dim(mutation_dat)

DBI::dbListTables(my_con)

```
## Step 4: Run the low expressors analysis on RNAseq data
Use just 1000 randomly selected genes for this analysis rather than the whole set.  
Analysis takes several minutes to run even with parallel processing
```{r eval=TRUE}

bisep_output <- doBISEPAnalysis(my_con, genes_n=100000)
#bisep_output <- doBISEPAnalysis(my_con, genes_n=1000)

```
    
    
## Step 5: View the results of the low expressors analysis
```{r eval=TRUE}

bisep_results <- src_sqlite(my_con@dbname) %>%
    dplyr::tbl('bisep_results') %>%
    dplyr::filter(bisep_pval < 0.1 & pi_value <0.2) %>% 
    dplyr::collect() %>% 
#    dplyr::slice(1:100) %>%
    inner_join(all_genes, by=c('gene_name'='gene_id')) %>%
    dplyr::select(gene_name, gene_name.y, everything()) %>%
    dplyr::arrange(gene_name.y)
bisep_results

```

## Step 6: Generate a plot for a given gene

```{r eval=TRUE}
doRNAseqPlot(my_con, 'ENSG00000176024')

```

## Step 7: Do the human paralogue analysis

```{r eval = TRUE}

human_paralog_res <- countHumanParalogs(my_con, bisep_results$gene_name)
#human_paralog_res <- countHumanParalogs(my_con, sample(all_genes$gene_id, 1000))

```

## Step 8: Do the FlyMine analysis
``` {r eval = TRUE}

fly_orthologs <- getOrthologs(my_con, results$gene_name, 'dmelanogaster')
flymine_res <- doFlyMineAnalysis(my_con, bisep_results$gene_name)
#flymine_res <- doFlyMineAnalysis(my_con, sample(all_genes$gene_id, 1000))

```

## Step 9: Do the WormMine analysis
``` {r eval = TRUE}

worm_orthologs <- getOrthologs(my_con, results$gene_name, 'celegans')
wormmine_res <- doWormMineAnalysis(my_con, bisep_results$gene_name)
#wormmine_res <- doWormMineAnalysis(my_con, sample(all_genes$gene_id, 1000))

```

## Step 10: Do the mutation analysis
``` {r eval = TRUE}

mut_res <- doMutationAnalysis(my_con, bisep_results$gene_name)
#mut_res <- doMutationAnalysis(my_con, sample(all_genes$gene_id, 1000))

```

## Step 11: Combine the results
``` {r eval=TRUE}
combo_res <- combineResults(my_con, bisep_results$gene_name)
```

## Step 12: Filter the results
``` {r eval=TRUE}
    filtered_results <- src_sqlite(my_con@dbname) %>%
    dplyr::tbl('combined_results') %>%
    dplyr::filter(count_paralogs > 0 & count_paralogs < 5) %>% 
    dplyr::filter(lethal_pct_fly > 20 | lethal_pct_worm > 20) %>%
    dplyr::collect() 
```

