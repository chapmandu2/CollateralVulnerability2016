#' Shiny Visualisation Server
#'
#' Creates a shiny server for the interactive view of Collateral Vulnerability pipeline results
#'
#' @param input Blah
#' @param output Blah
#' @param con A \code{SQLiteConnection} object to the database
#' @return A shiny server
#' @export
#' @import shiny
shinyVisServer <- function(input, output, con) {

    proc_data <- reactive({
        dplyr::src_sqlite(con@dbname) %>%
            dplyr::tbl('combined_results') %>%
            dplyr::filter(pi_value <= input$pi_value_th,
                          bisep_pval <= input$bisep_pval_th,
                              count_paralogs >= input$paralog_count_range[1],
                              count_paralogs <= input$paralog_count_range[2],
                              (lethal_pct_fly >= input$lethal_pct_fly | lethal_pct_worm >= input$lethal_pct_worm)
                          ) %>%
            dplyr::select(-c(mutations, paralog_ids)) %>%
            dplyr::arrange(bisep_pval) %>%
            dplyr::collect() %>%
            as.data.frame()

    })

    proc_gene_selected <- reactive({
        if(input$display_type == 'table') {
            proc_data()[input$results_row_last_clicked,'gene_id']
        } else if (input$display_type == 'scatter') {
            vals$gene_selected
        }
    })

    proc_bisep_plot <- reactive({
        out_plot <- plotBISEPOutput(con, highlighted_gene = proc_gene_selected(),
                                    pi_value_th = input$pi_value_th,
                                    bisep_pval_th = input$bisep_pval_th)
        out_data <- as.data.frame(out_plot$data)
        return(list(plot=out_plot, data=out_data))

    })

    # Toggle points that are clicked
    vals <- reactiveValues(
        gene_selected = NULL
    )

    #identify clicked points
    #try this? https://data.nozav.org/app/scatterD3/
    observeEvent(input$bisep_plot_click, {
        res <- nearPoints(proc_bisep_plot()$data, input$bisep_plot_click,  threshold=10, allRows=FALSE, addDist=TRUE)
        if(nrow(res) > 0) {
            vals$gene_selected <- res$gene_id[1]
        } else {
            vals$gene_selected <- NULL
        }

    })

    output$mut_data <- renderTable({
        selected_genes <- proc_gene_selected()
        dplyr::src_sqlite(con@dbname) %>%
            dplyr::tbl('mutation_analysis_data') %>%
            dplyr::filter(gene_id == selected_genes) %>%
            dplyr::select(Protein_Change) %>%
            dplyr::collect() %>%
            as.data.frame()

    })

    output$paralog_data <- renderTable({

        if(length(proc_gene_selected()) > 0) {
            tableParalogDetails(con, proc_gene_selected())
        }

    })

    output$flymine_data <- renderTable({

        if(length(proc_gene_selected()) > 0) {
            tableFlymineDetails(con, proc_gene_selected())
        }

    })

    output$wormmine_data <- renderTable({

        if(length(proc_gene_selected()) > 0) {
            tableWormMineDetails(con, proc_gene_selected())
        }

    })

    output$results <- DT::renderDataTable({
        proc_data()
    }, filter='top', selection = 'single', options=list(pageLength = 25, lengthMenu = c(5,10, 25, 50, 100)))

    output$bisep_plot <- renderPlot({
        proc_bisep_plot()$plot
    })

    output$rnaseq_plot <- renderPlot({
        if(length(proc_gene_selected()) > 0) {
            doRNAseqPlot(con, proc_gene_selected())
        }
    })

    output$paralog_plot <- renderPlot({
        if(length(proc_gene_selected()) > 0) {
            plotParalogRNAseq(con, proc_gene_selected())
        }
    })

    #contents of the display panel depending on what is chosen
    output$displayUI <- renderUI({
        if(input$display_type == 'scatter') {
            fluidRow(
                plotOutput('bisep_plot', click = "bisep_plot_click"),
                downloadButton('downloadBISEPData', 'Download Data')
            )
        } else if (input$display_type == 'table') {
            fluidRow(
                DT::dataTableOutput('results'),
                downloadButton('downloadData', 'Download Data')
            )
        }
    })

    #contents of the detail panel depending on what is chosen
    output$detailUI <- renderUI({
        if ( input$detail_type == 'rnaseq_plot') {
            plotOutput('rnaseq_plot')
        } else if (input$detail_type == 'mut_data') {
            tableOutput('mut_data')
        } else if (input$detail_type == 'paralog_plot') {
            plotOutput('paralog_plot')
        } else if (input$detail_type == 'paralog_data') {
            tableOutput('paralog_data')
        } else if (input$detail_type == 'flymine_data') {
            tableOutput('flymine_data')
        } else if (input$detail_type == 'wormmine_data') {
            tableOutput('wormmine_data')
        }
    })

    output$test <- renderText({})

    output$downloadData <- downloadHandler(
        filename = "data_download.txt",
        content = function(file) {
            write.table (proc_data(), file = file, sep = '\t', row.names = FALSE, col.names=TRUE, na='')
        }
    )

    output$downloadBISEPData <- downloadHandler(
        filename = 'bisep_data_download.txt',
        content = function(file) {
            write.table(proc_bisep_plot()$data, file=file, sep='\t', row.names = FALSE, col.names = TRUE, na='')
        }
    )




}
