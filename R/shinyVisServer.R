#' Shiny Visualisation Server
#'
#' Creates a shiny server for the interactive view of Collateral Vulnerability pipeline results
#'
#' @param input Blah
#' @param output Blah
#' @param con A \code{SQLiteConnection} object to the database
#' @return A shiny server
#' @export
#' @import shiny
shinyVisServer <- function(input, output, con) {

    proc_data <- reactive({
        dplyr::src_sqlite(con@dbname) %>%
            dplyr::tbl('combined_results') %>%
            dplyr::filter(count_paralogs > 0 & count_paralogs <= input$paralog_count_max & (lethal_pct_fly >= input$lethal_pct_fly | lethal_pct_worm >= input$lethal_pct_worm)) %>%
            dplyr::select(-c(mutations, paralog_ids)) %>%
            dplyr::arrange(bisep_pval) %>%
            dplyr::collect() %>%
            as.data.frame()

    })

    proc_gene_selected <- reactive({
        proc_data()[input$results_rows_selected,'gene_id']
    })

    output$mut_data <- renderTable({
        selected_genes <- proc_gene_selected()
        dplyr::src_sqlite(con@dbname) %>%
            dplyr::tbl('mutation_analysis_data') %>%
            dplyr::filter(gene_id == selected_genes) %>%
            dplyr::select(Protein_Change) %>%
            dplyr::collect() %>%
            as.data.frame()

    })

    output$paralog_data <- renderTable({

        if(length(proc_gene_selected()) > 0) {
            tableParalogDetails(con, proc_gene_selected())
        }

    })

    output$flymine_data <- renderTable({

        if(length(proc_gene_selected()) > 0) {
            tableFlymineDetails(con, proc_gene_selected())
        }

    })

    output$wormmine_data <- renderTable({

        if(length(proc_gene_selected()) > 0) {
            tableWormMineDetails(con, proc_gene_selected())
        }

    })

    output$results <- DT::renderDataTable({
        proc_data()
    }, filter='top', selection = 'single', options=list(pageLength = 25, lengthMenu = c(5,10, 25, 50, 100)))

    output$rnaseq_plot <- renderPlot({
        if(length(proc_gene_selected()) > 0) {
            doRNAseqPlot(con, proc_gene_selected())
        }
    })

    output$paralog_plot <- renderPlot({
        if(length(proc_gene_selected()) > 0) {
            plotParalogRNAseq(con, proc_gene_selected())
        }
    })

    output$detailUI <- renderUI({
        if ( input$detail_type == 'rnaseq_plot') {
            plotOutput('rnaseq_plot')
        } else if (input$detail_type == 'mut_data') {
            tableOutput('mut_data')
        } else if (input$detail_type == 'paralog_plot') {
            plotOutput('paralog_plot')
        } else if (input$detail_type == 'paralog_data') {
            tableOutput('paralog_data')
        } else if (input$detail_type == 'flymine_data') {
            tableOutput('flymine_data')
        } else if (input$detail_type == 'wormmine_data') {
            tableOutput('wormmine_data')
        }
    })

    output$test <- renderText({})



}
