#' BISEP Plot
#'
#' Plot to visualise BISEP output
#'
#' @param con A \code{SQLiteConnection} object
#' @param highlighted_gene Highlight the provided gene on the plot.  Default NULL - ie don't highlight anything
#' @param pi_value_th Set a PI value threshold.  Default 0.2
#' @param bisep_pval_th Set a BISEP p-value threshold.  Default 0.1
#' @param bi_value_th Set a Bimodal Index threshold.  Default 0
#' @return A ggplot2 object
#' @import ggplot2
#' @export
plotBISEPOutput <- function(con, highlighted_gene=NULL, pi_value_th=0.2, bisep_pval_th=0.1, bi_value_th=0) {

    #get the BISEP output data
    bisep_output <- dplyr::src_sqlite(con@dbname) %>%
        dplyr::tbl('bisep_results') %>%
        dplyr::collect()

    if(bi_value_th > 0) {
        plot_data <- bisep_output %>%
            dplyr::mutate(selected=pi_value <= pi_value_th & bisep_pval <= bisep_pval_th & BI >= bi_value_th)
    } else {
        plot_data <- bisep_output %>%
            dplyr::mutate(selected=pi_value <= pi_value_th & bisep_pval <= bisep_pval_th)
    }


    num_filtered_genes <- plot_data %>% dplyr::filter(selected) %>% nrow()

    #bisep_pval vs pi_val plot
    p1 <- ggplot(plot_data, aes(x=pi_value, y=bisep_pval, colour=selected)) +
        geom_point(size=rel(0.3)) +
        geom_vline(xintercept=pi_value_th, colour='blue') +
        geom_hline(yintercept=bisep_pval_th, colour='blue') +
        scale_y_log10() +
        theme_bw() +
        ggtitle(sprintf("%s genes @ pi_value < %s & bisep_pval < %s & bi_value > %s", num_filtered_genes, pi_value_th, bisep_pval_th, bi_value_th))

    #highlight the selected gene if provided
    if(!is.null(highlighted_gene)) {
        highlight_data <- plot_data %>%
            dplyr::filter(gene_id == highlighted_gene)
        p1 <- p1 + geom_point(data=highlight_data, shape=1, colour='black', size=rel(2)) +
            ggrepel::geom_label_repel(data=highlight_data,
                                      aes(label = gene_name),
                                      size = 5, colour='black',
                                      box.padding = unit(0.35, "lines"),
                                      point.padding = unit(0.3, "lines"))
    }


    return(p1)

}
