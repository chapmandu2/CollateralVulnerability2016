#' Get TCGA RNAseq data
#'
#' Downloads, filters and populates the SQLite database with TCGA RNAseq data using functionality from the \pkg{RTCGA}
#'
#' @param con A \code{SQLiteConnection} object
#' @param releaseDate
#' @param sampletag
#' @param sampleids
#'
#' @return a data frame
#' @export
#' @import RTCGA tidyr dplyr
#'
#' @examples
getTCGARNAseqData <- function(con, releaseDate, sampletag='01A', sampleids=NULL) {

    releaseDate <- '2015-11-01'

    #set up temporary dir
    dld <- paste(tempdir(), format(Sys.time(), "%Y%m%d%H%M%OS6"), sep='/')
    dir.create(dld)
    downloadTCGA( cancerTypes = "SKCM", destDir = dld, date = releaseDate,
                  dataSet = "rnaseqv2__illuminahiseq_rnaseqv2__unc_edu__Level_3__RSEM_genes_normalized__data.Level" )

    # reading data
    datadir <- list.files( dld) %>% file.path( dld, .)
    RNAseqfile <- datadir %>% list.files %>% grep( pattern = 'illuminahiseq', x = ., value = TRUE)
    rnaseq_data <- readTCGA( path = file.path( datadir, RNAseqfile), dataType = 'rnaseq' )

    # convert colnames to ensembl ids
    colname_table <- data.frame(colnames=colnames(rnaseq_data)[-1],
                                entrezid = gsub('^(.*)\\|', '', colnames(rnaseq_data)[-1]),
                                stringsAsFactors = FALSE) %>%
        dplyr::mutate(idx=1+row_number())

    # make ensembl to entrez conversion table
    conv_table <- dplyr::src_sqlite(con@dbname) %>%
        dplyr::tbl('human_genes') %>%
        dplyr::select(gene_id, entrezid) %>%
        dplyr::collect() %>%
        dplyr::group_by(entrezid) %>%
        dplyr::summarise(N=n(), first_ensid=first(gene_id, order_by=gene_id)) %>%
        dplyr::ungroup() %>%
        dplyr::arrange(desc(N))

    #combine ensembl and entrezid tables
    combo_table <- colname_table %>%
        dplyr::inner_join(conv_table, by='entrezid') %>%
        dplyr::group_by(first_ensid) %>%
        dplyr::mutate(dup_ensid = n()>1) %>%
        dplyr::ungroup()

    #filter rnaseq columns
    rnaseq_data_filtered <- rnaseq_data [ , c(1,combo_table$idx) ]
    colnames(rnaseq_data_filtered)[-1] <- combo_table$first_ensid

    #make tall and skinny
    rnaseq_data_tall <- rnaseq_data_filtered %>%
        tidyr::gather(key = 'gene_id', value = 'value', -bcr_patient_barcode)

    #add PatientID and SampleID columns
    rnaseq_data_tall <- rnaseq_data_tall %>%
        dplyr::mutate(SampleID = substr(bcr_patient_barcode, 1, 16),
               PatientID = substr(SampleID, 1, 12),
               sampletag = substr(SampleID,14,16))

    ###  MAKE SURE ONLY ONE SAMPLE PER PATIENT!!

    ###  WRITE TO DATABASE
    DBI::dbWriteTable(con, 'tcga_rnaseq_data', rnaseq_data_tall, overwrite=TRUE)

    ###  INDEX DATABASE

    return(rnaseq_data_tall)

}
