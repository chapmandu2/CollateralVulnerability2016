#' BISEP Analysis
#'
#' The BISEP analysis function identifies genes with bimodel expression profiles.  See \code{\link[BiSEp]{BiSEp}} documentation
#'
#' @param con A \code{SQLiteConnection} object
#' @param genes_n Permits a random subsample of genes to be analysed rather than the full set
#'
#' @return A data frame
#' @export
#' @import parallel doParallel foreach BiSEp
doBISEPAnalysis <- function(con, genes_n=NULL) {

    message('Get RNAseq data and reformat')
    rnaseq_mat_df <-  dplyr::src_sqlite(my_con@dbname) %>%
        dplyr::tbl('tcga_rnaseq_data') %>%
        dplyr::select(patient_id, gene_id, value) %>%
        collect() %>%
        dplyr::mutate(value=ifelse(value==0, NA, value)) %>%
        tidyr::spread(patient_id, value) %>%
        as.data.frame()
    dim(rnaseq_mat_df)

    message('Convert data into matrix')
    rnaseq_mat <- rnaseq_mat_df
    rownames(rnaseq_mat) <- rnaseq_mat$gene_id
    rnaseq_mat <- rnaseq_mat[,-1]
    rnaseq_mat <- log2(as.matrix(rnaseq_mat))

    #work out the variance and proportion of NA's for each gene
    gene_vars <- apply(rnaseq_mat, 1, var, na.rm=TRUE)
    gene_naprop <- apply(rnaseq_mat, 1, function(x) sum(is.na(x))/length(x))

    #try BISEP on genes with a sufficiently high variance
    n_cores <- parallel::detectCores()
    cl <- parallel::makeCluster(n_cores)
    doParallel::registerDoParallel(cl)

    x <- which(gene_vars>0.02 & gene_naprop<0.3)  #col ids of genes to use

    #sampling of gene ids for testing - since BISEP can take a long time, option to just look at a subset of genes
    if(is.numeric(genes_n) & genes_n <= length(x)) {
        x <- sample(x, genes_n)
    }

    x_list <- split(x, sample(1:n_cores, length(x), replace=TRUE))  #list of vectors to parallelise across

    message(sprintf('Running BiSEp on %s genes...', length(x)))
    bisep_out <- foreach::foreach(i=1:n_cores) %dopar%
        BiSEp::BISEP(rnaseq_mat[x_list[[i]], ])  #parallelise BISEP analysis using list of vectors to split up work

    message('Finished BiSEp: processing results')

    parallel::stopCluster(cl)

    biIndex <- lapply(bisep_out, function(z) dplyr::add_rownames(z$BI, 'gene_name')) %>%  #extract out BI results
        dplyr::bind_rows()

    bisepIndex <- lapply(bisep_out, function(z) dplyr::add_rownames(z$BISEP, 'gene_name')) %>% #extract out BISEP results
        dplyr::bind_rows()

    bisep_results <- biIndex %>%
        dplyr::inner_join(bisepIndex, by='gene_name') %>%
        as.data.frame()

    message('Writing results to database')
    DBI::dbWriteTable(con, 'bisep_results', bisep_results, overwrite=TRUE)

    message('Finished!')
    return(bisep_results)

}
